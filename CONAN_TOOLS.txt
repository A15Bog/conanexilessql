
CREATED BY =A15=Bog. Last modified 3/7.
Search the server browser for A15.
We are ranked #3 on topgameservers, #5 on gametracket, #11 on battlemetrics as of 3/7.
US PVP. No exploits, 1x raid on a target per day, 1 person stack limit, no racism, unradable bases allowed, .4 claim radius, 0 admin abuse.

--MAINTENANCE. RUN THIS AFTER USING ANYTHING BELOW.
VACUUM;
REINDEX;
ANALYZE;
pragma integrity_check;

--NEW AS OF 3/9: COMPLETED OLD OBJECTS DELETE, ADD POINTS TO RECIPES ON HITTING LEVEL 50, FIX PLAYERS IN GREY AREA OR CANNOT LOGIN, ALL TESTED IN PRODUCTION ON A15 SERVER.

--DELETE OBJECTS FROM PLAYERS OR GUILDS WHO LONGER EXIST -- just completed coding and testing, will test in production on 3/9
delete from buildable_health where object_id in (select distinct object_id from buildings where owner_id not in (select id from characters) and owner_id not in (select guildid from guilds));
delete from building_instances where object_id in (select distinct object_id from buildings where owner_id not in (select id from characters) and owner_id not in (select guildid from guilds));
delete from properties where object_id in (select distinct object_id from buildings where owner_id not in (select id from characters) and owner_id not in (select guildid from guilds));
delete from actor_position where object_id in (select distinct object_id from buildings where owner_id not in (select id from characters) and owner_id not in (select guildid from guilds));
delete from item_properties where owner_id in (select distinct owner_id from buildings where owner_id not in (select id from characters) and owner_id not in (select guildid from guilds));
delete from properties where object_id in (select distinct object_id from properties where name like '%Player%') and object_id not in (select id from characters) and object_id not in (select guildid from guilds);
delete from item_inventory where owner_id in (select distinct owner_id from buildings where owner_id not in (select id from characters) and owner_id not in (select guildid from guilds));
delete from buildings where owner_id not in (select id from characters) and owner_id not in (select guildid from guilds);

--ADDS 100 POINTS AVAILABLE TO RECIPES AFTER HITTING LEVEL 50. FIRST STATEMENT ALTERS EXISINGT LEVEL 50's.
update character_stats set stat_value = '384.0' where stat_value='284.0' and stat_type = '0' and stat_id = '3';
CREATE TRIGGER character_stats_bog_add_recipe_points
AFTER UPDATE OF stat_value
ON character_stats
FOR EACH ROW
BEGIN
UPDATE character_stats set stat_value = '384.0'
WHERE stat_value = '284.0'
AND stat_type = '0'
AND stat_id = '3';
END;

--FIX PLAYERS THAT ARE STUCK IN THE UPSIDE DOWN OR CANNOT LOGIN
update actor_position set x='59939.539063', y='310979.625', z='-21411.023438' where x = '1.0' or x = '0.0';

--DELETE OBJECTS FROM PLAYERS OR GUILDS WHO LONGER EXIST
delete from buildable_health where object_id in (select distinct object_id from buildings where owner_id not in (select id from characters) and owner_id not in (select guildid from guilds));
delete from building_instances where object_id in (select distinct object_id from buildings where owner_id not in (select id from characters) and owner_id not in (select guildid from guilds));
delete from properties where object_id in (select distinct object_id from buildings where owner_id not in (select id from characters) and owner_id not in (select guildid from guilds));
delete from actor_position where object_id in (select distinct object_id from buildings where owner_id not in (select id from characters) and owner_id not in (select guildid from guilds));
delete from item_properties where owner_id in (select distinct owner_id from buildings where owner_id not in (select id from characters) and owner_id not in (select guildid from guilds));
delete from properties where object_id in (select distinct object_id from properties where name like '%Player%') and object_id not in (select id from characters) and object_id not in (select guildid from guilds);
delete from item_inventory where owner_id in (select distinct owner_id from buildings where owner_id not in (select id from characters) and owner_id not in (select guildid from guilds));
delete from buildings where owner_id not in (select id from characters) and owner_id not in (select guildid from guilds);

--ADDS 100 POINTS AVAILABLE TO RECIPES AFTER HITTING LEVEL 50. FIRST STATEMENT ALTERS EXISINGT LEVEL 50's.
update character_stats set stat_value = '384.0' where stat_value='284.0' and stat_type = '0' and stat_id = '3';
CREATE TRIGGER character_stats_bog_add_recipe_points
AFTER UPDATE OF stat_value
ON character_stats
FOR EACH ROW
BEGIN
UPDATE character_stats set stat_value = '384.0'
WHERE stat_value = '284.0'
AND stat_type = '0'
AND stat_id = '3';
END;

--FIX PLAYERS THAT ARE STUCK IN THE UPSIDE DOWN OR CANNOT LOGIN
update actor_position set x='59939.539063', y='310979.625', z='-21411.023438' where x = '1.0' or x = '0.0';

--FIND OWNER IDS
.headers on
select guildid from guilds where name = 'GUILDNAME';
select playerid, id from characters where char_name = 'PLAYERNAME' or guild = 'GUILD_ID';

--DELETE ALL BEDROLLS AND CAMPFIRES FROM SERVER - VERIFIED IN PRODUCTION ON 3/8
delete from buildable_health where object_id in (select distinct object_id from buildings where object_id in (select distinct object_id from properties where name like '%Bedroll%' or name like '%CampFire%'));
delete from building_instances where object_id in (select distinct object_id from buildings where object_id in (select distinct object_id from properties where name like '%Bedroll%' or name like '%CampFire%'));
delete from actor_position where id in (select distinct object_id from buildings where object_id in (select distinct object_id from properties where name like '%Bedroll%' or name like '%CampFire%'));
delete from item_inventory where template_id in ('12001','10001');
delete from buildings where object_id in (select distinct object_id from properties where name like '%Bedroll%' or name like '%CampFire%');
delete from properties where name like '%Bedroll%' or name like '%CampFire%';

--DELETE PLAYERS AND/OR GUILDS ALONG WITH EVERYTHING THEY OWN ON THE SERVER
delete from buildable_health where object_id in (select distinct object_id from buildings where owner_id in (select id from characters where playerid in ('76561198007754084','76561198338700832','76561198237151710','76561198311432927','76561198355649515'))) or object_id in (select distinct object_id from buildings where owner_id = '8584');
delete from building_instances where object_id in (select distinct object_id from buildings where owner_id in (select id from characters where playerid in ('76561198007754084','76561198338700832','76561198237151710','76561198311432927','76561198355649515'))) or object_id in (select distinct object_id from buildings where owner_id = '8584');
delete from properties where object_id in (select distinct object_id from buildings where owner_id in (select id from characters where playerid in ('76561198007754084','76561198338700832','76561198237151710','76561198311432927','76561198355649515'))) or object_id in (select distinct object_id from buildings where owner_id = '8584');
delete from actor_position where id in (select distinct object_id from buildings where owner_id in (select id from characters where playerid in ('76561198007754084','76561198338700832','76561198237151710','76561198311432927','76561198355649515'))) or id in (select distinct object_id from buildings where owner_id = '8584');
delete from properties where object_id in (select id from characters where playerid in ('76561198007754084','76561198338700832','76561198237151710','76561198311432927','76561198355649515')) or object_id = '8584';
delete from buildings where owner_id in (select id from characters where playerid in ('76561198007754084','76561198338700832','76561198237151710','76561198311432927','76561198355649515')) or owner_id = '8584';
delete from item_properties where owner_id in (select id from characters where playerid in ('76561198007754084','76561198338700832','76561198237151710','76561198311432927','76561198355649515')) or owner_id = '8584';
delete from item_inventory where owner_id in (select id from characters where playerid in ('76561198007754084','76561198338700832','76561198237151710','76561198311432927','76561198355649515')) or owner_id = '8584';
delete from actor_position where id in (select id from characters where playerid in ('76561198007754084','76561198338700832','76561198237151710','76561198311432927','76561198355649515')) or id = '8584';
delete from character_stats where char_id in (select id from characters where playerid in ('76561198007754084','76561198338700832','76561198237151710','76561198311432927','76561198355649515'));
delete from characters where playerid in ('76561198007754084','76561198338700832','76561198237151710','76561198311432927','76561198355649515');
delete from guilds where guildid = '8584';

--EXPORT CSV OF ALL GUILDS, LEADERS, CHARACTERS, LEVEL, RANK
.headers on
.mode csv
.once guildplayers.csv
select quote(g.name) as GUILD, quote(g.guildid) as GUILDid, quote(c.char_name) as NAME, case c.rank WHEN '2' then 'Leader' WHEN '1' then 'Officer' WHEN '0' then 'Peon' ELSE c.rank END RANK, c.level as LEVEL, quote(c.playerid) as STEAMid, quote(c.id) as DBid from guilds g inner join characters c on g.guildid = c.guild order by g.name, c.rank desc, c.level desc, c.char_name;
.headers on
.mode csv
.once soloplayers.csv
select quote(char_name) as NAME, level as LEVEL, quote(playerID) as STEAMid, quote(id) as DBid from characters where id not in (select distinct c.id from guilds g inner join characters c on g.guildid = c.guild order by g.name, c.rank desc, c.level desc, c.char_name) order by char_name, level;

--EXPORT CSV OF ALL ITEMS A PLAYER OR GUILD OWNS. REPLACE 'GUILD_OR_PLAYERID' IN THE SCRIPT.
.headers on
.mode csv
.once placed_buildings_items.csv
select count(class) as cnt,class from building_instances where object_id in (select object_id from buildings where owner_id = 'GUILD_OR_PLAYERID') group by class order by cnt desc;
.headers on
.mode csv
.once craftable_items.csv
select count(name) as cnt,name from properties where object_id in (select object_id from buildings where owner_id = 'GUILD_OR_PLAYERID') group by name order by cnt desc;

--UPDATE CHARACTER NAME
update characters set char_name = 'Newname' where char_name = 'Oldname';

--REMOVES ALL ITEMS AND BUILDINGS EXCEPT THOSE BELONGING TO A SINGLE PLAYER AND GUILD (USED FOR EVENTS)
delete from buildable_health where object_id in (select distinct object_id from buildings where owner_id not in (select id from characters where char_name = 'CHARACTERNAME') and owner_id not in (select guildid from guilds where name = 'GUILDNAME'));
delete from building_instances where object_id in (select distinct object_id from buildings where owner_id not in (select id from characters where char_name = 'CHARACTERNAME') and owner_id not in (select guildid from guilds where name = 'GUILDNAME'));
delete from properties where object_id in (select distinct object_id from buildings where owner_id not in (select id from characters where char_name = 'CHARACTERNAME') and owner_id not in (select guildid from guilds where name = 'GUILDNAME'));
delete from properties where object_id in (select id from characters where char_name <> 'CHARACTERNAME');
delete from actor_position where id in (select distinct object_id from buildings where owner_id not in (select id from characters where char_name = 'CHARACTERNAME') and owner_id not in (select guildid from guilds where name = 'GUILDNAME'));
delete from buildings where owner_id in (select distinct owner_id from buildings where owner_id not in (select id from characters where char_name = 'CHARACTERNAME') and owner_id not in (select guildid from guilds where name = 'GUILDNAME'));
delete from item_properties where owner_id in (select id from characters where char_name <> 'CHARACTERNAME') or owner_id in (select guildid from guilds where name <> 'GUILDNAME');
delete from item_inventory where owner_id in (select id from characters where char_name <> 'CHARACTERNAME') or owner_id in (select guildid from guilds where name <> 'GUILDNAME');
delete from actor_position where id in (select id from characters where char_name <> 'CHARACTERNAME') or id in (select guildid from guilds where name <> 'GUILDNAME');
delete from character_stats where char_id in (select id from characters where char_name <> 'CHARACTERNAME');
delete from characters where id in (select id from characters where char_name <> 'CHARACTERNAME');
delete from guilds where guildid in (select guildid from guilds where name <> 'GUILDNAME');
VACUUM;
REINDEX;
ANALYZE;
pragma integrity_check;

